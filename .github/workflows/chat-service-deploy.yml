name: chat-service-deploy

# ÌäπÏ†ï Ìè¥ÎçîÎßå Ï†ÅÏö©
# on:
#   push:
#     paths:
#       - 'chat-service/**'

on:
  push:

jobs:
  CI-CD:
    runs-on: ubuntu-latest
    steps:
    
      # JDK setting - github actionsÏóêÏÑú ÏÇ¨Ïö©Ìï† JDK ÏÑ§Ï†ï (ÌîÑÎ°úÏ†ùÌä∏ÎÇò AWSÏùò java Î≤ÑÏ†ÑÍ≥º Îã¨ÎùºÎèÑ Î¨¥Î∞©)
      - uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      
      # - name: make application.yml
      #   if: |
      #     contains(github.ref, 'main') ||
      #     contains(github.ref, 'develop')
      #   run: |
      #     mkdir ./src/main/resources # resources Ìè¥Îçî ÏÉùÏÑ±
      #     cd ./src/main/resources # resources Ìè¥ÎçîÎ°ú Ïù¥Îèô
      #     touch ./application.yml # application.yml ÏÉùÏÑ±
      #     echo "${{ secrets.YML }}" > ./application.yml # github actionsÏóêÏÑú ÏÑ§Ï†ïÌïú Í∞íÏùÑ application.yml ÌååÏùºÏóê Ïì∞Í∏∞
      #   shell: bash

      # # ÌôòÍ≤ΩÎ≥Ñ yml ÌååÏùº ÏÉùÏÑ±(2) - dev
      # - name: make application-dev.yml
      #   if: contains(github.ref, 'develop')
      #   run: |
      #     cd ./src/main/resources
      #     touch ./application-dev.yml
      #     echo "${{ secrets.YML_DEV }}" > ./application-dev.yml
      #   shell: bash

      # # ÌôòÍ≤ΩÎ≥Ñ yml ÌååÏùº ÏÉùÏÑ±(3) - prod
      # - name: make application-prod.yml
      #   if: contains(github.ref, 'main')
      #   run: |
      #     cd ./src/main/resources
      #     touch ./application-prod.yml
      #     echo "${{ secrets.YML_PROD }}" > ./application-prod.yml
      #   shell: bash
      - name: Install JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'adopt'
          java-version: 17
          # cache: 'gradle' # https://github.com/actions/setup-java#caching-packages-dependencies
      
      - name: Build with Gradle
        run: |
          cd chat-service
          ./gradlew clean build
      - name: Comment test coverage on PR
        id: jacoco
        uses: madrapps/jacoco-report@v1.2
        with:
          title: üìù ÌÖåÏä§Ìä∏ Ïª§Î≤ÑÎ¶¨ÏßÄ Î¶¨Ìè¨Ìä∏
          paths: ${{ github.workspace }}/chat-service/build/jacoco/index.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 50
          min-coverage-changed-files: 50
      # docker build & push to production
      - name: Docker build & push to prod
        # if: contains(github.ref, 'main')
        run: |
          cd chat-service 
          docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
          docker build -f Dockerfile -t ${{ secrets.DOCKER_USERNAME }}/docker-test-prod .
          docker push ${{ secrets.DOCKER_USERNAME }}/docker-test-prod
      - name: Deploy to prod
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_PROD }} # EC2 ÌçºÎ∏îÎ¶≠ IPv4 DNS
          username: ec2-user
          key: ${{ secrets.PRIVATE_KEY }}
          port : 22
          script: |
            sudo docker ps
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/docker-testchat-prod
            sudo docker run -d -p 8761:8761 ${{ secrets.DOCKER_USERNAME }}/docker-testchat-prod
            sudo docker image prune -f
